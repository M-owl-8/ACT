# Manifest Merger Fix - Applied Solution

## Problem
The EAS production AAB build failed with the following error:

```
Manifest merger failed: Attribute meta-data#com.google.firebase.messaging.default_notification_color@resource 
value=(@color/notification_icon_color) from AndroidManifest.xml:16:88-137 
is also present at [:react-native-firebase_messaging] AndroidManifest.xml:46:13-44 value=(@color/white).
Suggestion: add 'tools:replace="android:resource"' to <meta-data> element at AndroidManifest.xml:16:5-139 to override.
```

### Root Cause
The app's notification configuration and the `react-native-firebase_messaging` library both define the same Firebase notification metadata attributes with different values. When Gradle tries to merge the manifests during the build process, it detects this conflict and fails.

**Conflicting Values:**
- App specifies: `com.google.firebase.messaging.default_notification_color` = `@color/notification_icon_color`
- Library specifies: `com.google.firebase.messaging.default_notification_color` = `@color/white`

## Solution Applied

### Created Custom Expo Plugin
Instead of manually editing the AndroidManifest.xml (which is generated by Expo), we created a custom Expo plugin that automatically adds the `tools:replace="android:resource"` attribute during the build process.

**Files Created:**
- `apps/mobile/plugins/android-manifest-fix.js` - Custom Expo config plugin

**Files Modified:**
- `apps/mobile/app.json` - Added reference to the custom plugin

### How It Works
The custom plugin:
1. Hooks into Expo's Android manifest generation process
2. Adds the `xmlns:tools` namespace to the manifest root element
3. Finds the Firebase notification metadata elements that conflict
4. Adds `tools:replace="android:resource"` to allow the app's values to override the library's values

### Plugin Details
```javascript
// apps/mobile/plugins/android-manifest-fix.js
- Uses Expo's `withAndroidManifest` from @expo/config-plugins
- Runs automatically during EAS build
- Modifies the XML manifest structure safely
- Targets:
  - com.google.firebase.messaging.default_notification_color
  - com.google.firebase.messaging.default_notification_icon
```

## Changes Made

### 1. app.json
Added the custom plugin to the plugins array:
```json
"plugins": [
  "expo-secure-store",
  ["expo-notifications", {...}],
  "./plugins/android-manifest-fix.js"
]
```

### 2. plugins/android-manifest-fix.js
New custom Expo plugin that modifies the Android manifest during build.

## Build Retry Steps

To retry the production AAB build:

```bash
cd apps/mobile
eas build --platform android --profile production --wait
```

## Expected Outcome
✅ Gradle manifest merger will no longer fail on conflicting Firebase metadata attributes
✅ App's notification color (`@color/notification_icon_color`) will be used
✅ Build will proceed to completion and generate the AAB file

## Benefits of This Approach
1. **No Manual File Management** - Doesn't rely on manually committing generated files
2. **Reproducible** - Works consistently across local and cloud builds
3. **Maintainable** - Uses Expo's plugin system which is the standard approach
4. **Safe** - Only modifies the manifest during build, no local file changes needed
5. **Scalable** - Can be extended to handle other manifest conflicts in the future

## Additional Resources
- Expo Config Plugins: https://docs.expo.dev/config-plugins/
- Android Manifest Merging: https://developer.android.com/build/manifest-merge
- Firebase Messaging in React Native: https://rnfirebase.io/messaging/usage

## Status
✅ **FIXED** - Changes committed and pushed to GitHub
⏳ **PENDING** - Awaiting EAS build retry with this fix

## Related Documentation
- `GRADLE_WRAPPER_FIX.md` - Previous fix for missing gradle wrapper
- `MANIFEST_MERGER_FIX.md` - Initial analysis of the manifest conflict